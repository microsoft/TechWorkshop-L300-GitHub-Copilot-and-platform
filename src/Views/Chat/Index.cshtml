@{
    ViewData["Title"] = "Chat";
    var isConfigured = ViewBag.IsConfigured ?? false;
}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="bi bi-chat-dots me-2"></i>Chat with Us</h4>
                </div>
                <div class="card-body">
                    @if (!isConfigured)
                    {
                        <div class="alert alert-warning" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Chat service is not configured. Please configure the Azure AI settings.
                        </div>
                    }
                    
                    <div id="chatMessages" class="border rounded p-3 mb-3" style="height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                        <div class="text-muted text-center py-5" id="welcomeMessage">
                            <i class="bi bi-chat-heart display-4"></i>
                            <p class="mt-3">Welcome! How can we help you today?</p>
                        </div>
                    </div>

                    <form id="chatForm" class="d-flex gap-2">
                        <input type="text" 
                               id="messageInput" 
                               class="form-control" 
                               placeholder="Type your message..." 
                               autocomplete="off"
                               @(isConfigured ? "" : "disabled")>
                        <button type="submit" 
                                class="btn btn-primary px-4" 
                                id="sendButton"
                                @(isConfigured ? "" : "disabled")>
                            <i class="bi bi-send"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            const chatMessages = $('#chatMessages');
            const messageInput = $('#messageInput');
            const chatForm = $('#chatForm');
            const sendButton = $('#sendButton');
            const welcomeMessage = $('#welcomeMessage');

            function appendMessage(message, isUser) {
                welcomeMessage.hide();
                
                const messageClass = isUser ? 'bg-primary text-white ms-auto' : 'bg-white border';
                const align = isUser ? 'text-end' : 'text-start';
                
                const messageHtml = `
                    <div class="mb-3 ${align}">
                        <div class="d-inline-block p-3 rounded ${messageClass}" style="max-width: 80%;">
                            ${escapeHtml(message)}
                        </div>
                    </div>
                `;
                
                chatMessages.append(messageHtml);
                chatMessages.scrollTop(chatMessages[0].scrollHeight);
            }

            function appendTypingIndicator() {
                const typingHtml = `
                    <div class="mb-3 text-start" id="typingIndicator">
                        <div class="d-inline-block p-3 rounded bg-white border">
                            <div class="typing-indicator">
                                <span></span><span></span><span></span>
                            </div>
                        </div>
                    </div>
                `;
                chatMessages.append(typingHtml);
                chatMessages.scrollTop(chatMessages[0].scrollHeight);
            }

            function removeTypingIndicator() {
                $('#typingIndicator').remove();
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            chatForm.on('submit', function(e) {
                e.preventDefault();
                
                const message = messageInput.val().trim();
                if (!message) return;

                appendMessage(message, true);
                messageInput.val('');
                sendButton.prop('disabled', true);
                messageInput.prop('disabled', true);
                
                appendTypingIndicator();

                $.ajax({
                    url: '@Url.Action("SendMessage", "Chat")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ message: message }),
                    success: function(data) {
                        removeTypingIndicator();
                        appendMessage(data.response, false);
                    },
                    error: function(xhr) {
                        removeTypingIndicator();
                        let errorMessage = 'Sorry, an error occurred. Please try again.';
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMessage = xhr.responseJSON.error;
                        }
                        appendMessage(errorMessage, false);
                    },
                    complete: function() {
                        sendButton.prop('disabled', false);
                        messageInput.prop('disabled', false);
                        messageInput.focus();
                    }
                });
            });

            messageInput.focus();
        });
    </script>

    <style>
        .typing-indicator {
            display: flex;
            gap: 4px;
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background-color: #6c757d;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @@keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }
    </style>
}
