name: Build and Deploy to Azure App Service

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: $.azurecr.io
  IMAGE_NAME: simplestore
  APP_NAME: $

jobs:
  build-and-deploy:
   runs-on: ubuntu-latest

   steps:
   - name: Checkout code
     uses: actions/checkout@v4

   - name: Log in to Azure
     uses: azure/login@v2
     with:
       creds: $

   - name: Log in to Azure Container Registry
     run: az acr login --name $

   - name: Build and push Docker image
     run: |
      # Build the Docker image
      docker build -t $/$:$ -t $/$:latest ./src

      # Push both tags to registry
      docker push $/$:$
      docker push $/$:latest

   - name: Deploy to Azure App Service
     uses: azure/webapps-deploy@v3
     with:
       app-name: $
       images: $/$:$
