name: Build and Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Login to Azure
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Build and push container image
      run: |
        az acr build \
          --registry ${{ vars.AZURE_CONTAINER_REGISTRY }} \
          --image zavastorefont:${{ github.sha }} \
          --image zavastorefont:latest \
          --file ./src/Dockerfile \
          ./src
    
    - name: Update Azure App Service to new image
      run: |
        az webapp config container set \
          --name ${{ vars.AZURE_APP_SERVICE_NAME }} \
          --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
          --docker-custom-image-name ${{ vars.AZURE_CONTAINER_REGISTRY }}.azurecr.io/zavastorefont:${{ github.sha }} \
          --docker-registry-server-url https://${{ vars.AZURE_CONTAINER_REGISTRY }}.azurecr.io \
          --acr-use-managed-identity true
