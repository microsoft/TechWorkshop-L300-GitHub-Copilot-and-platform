{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "3860986180104927099"
    }
  },
  "parameters": {
    "environmentName": {
      "type": "string",
      "defaultValue": "dev",
      "minLength": 1,
      "maxLength": 10,
      "metadata": {
        "description": "The environment name (e.g., dev, staging, prod)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "westus3",
      "metadata": {
        "azd": {
          "type": "location"
        },
        "description": "The Azure region for all resources"
      }
    },
    "projectName": {
      "type": "string",
      "defaultValue": "ZavaStorefront",
      "minLength": 1,
      "maxLength": 20,
      "metadata": {
        "description": "The project name used for resource naming"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "environment": "[parameters('environmentName')]",
        "project": "[parameters('projectName')]",
        "managedBy": "Bicep"
      },
      "metadata": {
        "description": "Tags to apply to all resources"
      }
    }
  },
  "variables": {
    "resourceToken": "[toLower(uniqueString(resourceGroup().id, parameters('environmentName'), parameters('location')))]",
    "acrPullRoleId": "7f951dda-4ed3-4680-a7ca-43fe172d538d"
  },
  "resources": {
    "monitoring": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('monitoring-{0}', variables('resourceToken'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "workspaceName": {
            "value": "[format('log-{0}-{1}-{2}', toLower(parameters('projectName')), parameters('environmentName'), variables('resourceToken'))]"
          },
          "appInsightsName": {
            "value": "[format('appi-{0}-{1}-{2}', toLower(parameters('projectName')), parameters('environmentName'), variables('resourceToken'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "retentionInDays": {
            "value": 30
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14290759443435177334"
            }
          },
          "parameters": {
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Log Analytics Workspace"
              }
            },
            "appInsightsName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Application Insights instance"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location for the monitoring resources"
              }
            },
            "retentionInDays": {
              "type": "int",
              "defaultValue": 30,
              "minValue": 30,
              "maxValue": 730,
              "metadata": {
                "description": "The retention in days for Log Analytics Workspace"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the monitoring resources"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[parameters('workspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": "[parameters('retentionInDays')]",
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                },
                "workspaceCapping": {
                  "dailyQuotaGb": -1
                },
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('appInsightsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]",
                "RetentionInDays": "[parameters('retentionInDays')]",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled",
                "DisableLocalAuth": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
              ]
            }
          ],
          "outputs": {
            "workspaceResourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Log Analytics Workspace"
              },
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Log Analytics Workspace"
              },
              "value": "[parameters('workspaceName')]"
            },
            "appInsightsResourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Application Insights instance"
              },
              "value": "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]"
            },
            "appInsightsName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Application Insights instance"
              },
              "value": "[parameters('appInsightsName')]"
            },
            "appInsightsConnectionString": {
              "type": "string",
              "metadata": {
                "description": "The connection string for Application Insights"
              },
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').ConnectionString]"
            },
            "appInsightsInstrumentationKey": {
              "type": "string",
              "metadata": {
                "description": "The instrumentation key for Application Insights"
              },
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').InstrumentationKey]"
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location of the monitoring resources"
              },
              "value": "[parameters('location')]"
            }
          }
        }
      }
    },
    "containerRegistry": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('acr-{0}', variables('resourceToken'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('acr{0}{1}{2}', toLower(parameters('projectName')), parameters('environmentName'), variables('resourceToken'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "acrSku": {
            "value": "Basic"
          },
          "acrAdminUserEnabled": {
            "value": false
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "roleAssignments": {
            "value": []
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11147634617806757127"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the Container Registry"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location of the Container Registry"
              }
            },
            "acrSku": {
              "type": "string",
              "defaultValue": "Basic",
              "allowedValues": [
                "Basic",
                "Standard",
                "Premium"
              ],
              "metadata": {
                "description": "The SKU name for the Container Registry"
              }
            },
            "acrAdminUserEnabled": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable admin user for Container Registry"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the Container Registry"
              }
            },
            "roleAssignments": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Role assignments for the Container Registry"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-07-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('acrSku')]"
              },
              "properties": {
                "adminUserEnabled": "[parameters('acrAdminUserEnabled')]",
                "publicNetworkAccess": "Enabled",
                "networkRuleBypassOptions": "AzureServices",
                "policies": {
                  "quarantinePolicy": {
                    "status": "disabled"
                  },
                  "retentionPolicy": {
                    "status": "disabled"
                  },
                  "trustPolicy": {
                    "status": "disabled"
                  }
                }
              }
            },
            {
              "copy": {
                "name": "containerRegistry_roleAssignments",
                "count": "[length(parameters('roleAssignments'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('name'))]",
              "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('name')), parameters('roleAssignments')[copyIndex()].principalId, parameters('roleAssignments')[copyIndex()].roleDefinitionIdOrName)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleAssignments')[copyIndex()].roleDefinitionIdOrName)]",
                "principalId": "[parameters('roleAssignments')[copyIndex()].principalId]",
                "principalType": "[coalesce(tryGet(parameters('roleAssignments')[copyIndex()], 'principalType'), 'ServicePrincipal')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerRegistry/registries', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Container Registry"
              },
              "value": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the Container Registry"
              },
              "value": "[parameters('name')]"
            },
            "loginServer": {
              "type": "string",
              "metadata": {
                "description": "The login server of the Container Registry"
              },
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('name')), '2023-07-01').loginServer]"
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location of the Container Registry"
              },
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('name')), '2023-07-01', 'full').location]"
            }
          }
        }
      }
    },
    "appServicePlan": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('asp-{0}', variables('resourceToken'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('asp-{0}-{1}-{2}', toLower(parameters('projectName')), parameters('environmentName'), variables('resourceToken'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "skuName": {
            "value": "B1"
          },
          "skuCapacity": {
            "value": 1
          },
          "kind": {
            "value": "linux"
          },
          "reserved": {
            "value": true
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "4567266417748153046"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the App Service Plan"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location of the App Service Plan"
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "B1",
              "metadata": {
                "description": "The SKU name for the App Service Plan"
              }
            },
            "skuCapacity": {
              "type": "int",
              "defaultValue": 1,
              "minValue": 1,
              "maxValue": 10,
              "metadata": {
                "description": "The SKU capacity (number of instances)"
              }
            },
            "kind": {
              "type": "string",
              "defaultValue": "linux",
              "allowedValues": [
                "app",
                "linux",
                "functionapp"
              ],
              "metadata": {
                "description": "The kind of App Service Plan (linux for Linux-based plans)"
              }
            },
            "reserved": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Reserved flag - must be true for Linux plans"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the App Service Plan"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2022-09-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "[parameters('kind')]",
              "sku": {
                "name": "[parameters('skuName')]",
                "capacity": "[parameters('skuCapacity')]"
              },
              "properties": {
                "reserved": "[parameters('reserved')]"
              }
            }
          ],
          "outputs": {
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the App Service Plan"
              },
              "value": "[resourceId('Microsoft.Web/serverfarms', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the App Service Plan"
              },
              "value": "[parameters('name')]"
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location of the App Service Plan"
              },
              "value": "[reference(resourceId('Microsoft.Web/serverfarms', parameters('name')), '2022-09-01', 'full').location]"
            }
          }
        }
      }
    },
    "appService": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('app-{0}', variables('resourceToken'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('app-{0}-{1}-{2}', toLower(parameters('projectName')), parameters('environmentName'), variables('resourceToken'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "appServicePlanId": {
            "value": "[reference('appServicePlan').outputs.resourceId.value]"
          },
          "dockerImage": {
            "value": "[format('{0}/zava-storefront:latest', reference('containerRegistry').outputs.loginServer.value)]"
          },
          "enableManagedIdentity": {
            "value": true
          },
          "httpsOnly": {
            "value": true
          },
          "appInsightsConnectionString": {
            "value": "[reference('monitoring').outputs.appInsightsConnectionString.value]"
          },
          "appInsightsInstrumentationKey": {
            "value": "[reference('monitoring').outputs.appInsightsInstrumentationKey.value]"
          },
          "additionalAppSettings": {
            "value": [
              {
                "name": "DOCKER_REGISTRY_SERVER_URL",
                "value": "[format('https://{0}', reference('containerRegistry').outputs.loginServer.value)]"
              },
              {
                "name": "WEBSITES_PORT",
                "value": "80"
              }
            ]
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "4628079194314069768"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the App Service"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location of the App Service"
              }
            },
            "appServicePlanId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the App Service Plan"
              }
            },
            "dockerImage": {
              "type": "string",
              "defaultValue": "mcr.microsoft.com/appsvc/staticsite:latest",
              "metadata": {
                "description": "The Docker image to use (e.g., myregistry.azurecr.io/myapp:latest)"
              }
            },
            "enableManagedIdentity": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable system-assigned managed identity"
              }
            },
            "httpsOnly": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enforce HTTPS only"
              }
            },
            "appInsightsConnectionString": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights connection string"
              }
            },
            "appInsightsInstrumentationKey": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights instrumentation key"
              }
            },
            "additionalAppSettings": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Additional app settings"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the App Service"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2022-09-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "app,linux,container",
              "identity": "[if(parameters('enableManagedIdentity'), createObject('type', 'SystemAssigned'), null())]",
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": "[parameters('httpsOnly')]",
                "siteConfig": {
                  "linuxFxVersion": "[format('DOCKER|{0}', parameters('dockerImage'))]",
                  "alwaysOn": true,
                  "ftpsState": "FtpsOnly",
                  "minTlsVersion": "1.2",
                  "http20Enabled": true,
                  "appSettings": "[union(createArray(createObject('name', 'WEBSITES_ENABLE_APP_SERVICE_STORAGE', 'value', 'false'), createObject('name', 'DOCKER_ENABLE_CI', 'value', 'true')), if(not(empty(parameters('appInsightsConnectionString'))), createArray(createObject('name', 'APPLICATIONINSIGHTS_CONNECTION_STRING', 'value', parameters('appInsightsConnectionString')), createObject('name', 'ApplicationInsightsAgent_EXTENSION_VERSION', 'value', '~3')), createArray()), if(not(empty(parameters('appInsightsInstrumentationKey'))), createArray(createObject('name', 'APPINSIGHTS_INSTRUMENTATIONKEY', 'value', parameters('appInsightsInstrumentationKey'))), createArray()), parameters('additionalAppSettings'))]"
                }
              }
            }
          ],
          "outputs": {
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the App Service"
              },
              "value": "[resourceId('Microsoft.Web/sites', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the App Service"
              },
              "value": "[parameters('name')]"
            },
            "defaultHostname": {
              "type": "string",
              "metadata": {
                "description": "The default hostname of the App Service"
              },
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('name')), '2022-09-01').defaultHostName]"
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "The principal ID of the system-assigned managed identity"
              },
              "value": "[if(parameters('enableManagedIdentity'), reference(resourceId('Microsoft.Web/sites', parameters('name')), '2022-09-01', 'full').identity.principalId, '')]"
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location of the App Service"
              },
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('name')), '2022-09-01', 'full').location]"
            }
          }
        }
      },
      "dependsOn": [
        "appServicePlan",
        "containerRegistry",
        "monitoring"
      ]
    },
    "aiFoundry": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('ai-{0}', variables('resourceToken'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "hubName": {
            "value": "[format('aihub-{0}-{1}-{2}', toLower(parameters('projectName')), parameters('environmentName'), variables('resourceToken'))]"
          },
          "projectName": {
            "value": "[format('aiproj-{0}-{1}-{2}', toLower(parameters('projectName')), parameters('environmentName'), variables('resourceToken'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "applicationInsightsId": {
            "value": "[reference('monitoring').outputs.appInsightsResourceId.value]"
          },
          "containerRegistryId": {
            "value": "[reference('containerRegistry').outputs.resourceId.value]"
          },
          "workspaceId": {
            "value": "[reference('monitoring').outputs.workspaceResourceId.value]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "17032743919308657808"
            }
          },
          "parameters": {
            "hubName": {
              "type": "string",
              "metadata": {
                "description": "The name of the AI Foundry Hub"
              }
            },
            "projectName": {
              "type": "string",
              "metadata": {
                "description": "The name of the AI Foundry Project"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location for AI Foundry resources"
              }
            },
            "applicationInsightsId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Application Insights instance"
              }
            },
            "containerRegistryId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Container Registry"
              }
            },
            "workspaceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Log Analytics Workspace"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to AI Foundry resources"
              }
            }
          },
          "variables": {
            "storageAccountName": "[take(replace(format('st{0}', uniqueString(resourceGroup().id, parameters('hubName'))), '-', ''), 24)]",
            "keyVaultName": "[take(format('kv-{0}', uniqueString(resourceGroup().id, parameters('hubName'))), 24)]"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[variables('storageAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot",
                "supportsHttpsTrafficOnly": true,
                "minimumTlsVersion": "TLS1_2",
                "allowBlobPublicAccess": false
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[variables('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "tenantId": "[subscription().tenantId]",
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "accessPolicies": [],
                "enableRbacAuthorization": true,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 7,
                "enabledForDeployment": false,
                "enabledForDiskEncryption": false,
                "enabledForTemplateDeployment": false
              }
            },
            {
              "type": "Microsoft.MachineLearningServices/workspaces",
              "apiVersion": "2024-04-01",
              "name": "[parameters('hubName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "friendlyName": "[parameters('hubName')]",
                "description": "AI Foundry Hub for ZavaStorefront",
                "storageAccount": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
                "keyVault": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
                "applicationInsights": "[parameters('applicationInsightsId')]",
                "containerRegistry": "[parameters('containerRegistryId')]",
                "publicNetworkAccess": "Enabled",
                "v1LegacyMode": false
              },
              "kind": "Hub",
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.MachineLearningServices/workspaces",
              "apiVersion": "2024-04-01",
              "name": "[parameters('projectName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "friendlyName": "[parameters('projectName')]",
                "description": "AI Foundry Project for ZavaStorefront development",
                "hubResourceId": "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('hubName'))]",
                "publicNetworkAccess": "Enabled"
              },
              "kind": "Project",
              "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('hubName'))]"
              ]
            }
          ],
          "outputs": {
            "hubResourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the AI Foundry Hub"
              },
              "value": "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('hubName'))]"
            },
            "hubName": {
              "type": "string",
              "metadata": {
                "description": "The name of the AI Foundry Hub"
              },
              "value": "[parameters('hubName')]"
            },
            "projectResourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the AI Foundry Project"
              },
              "value": "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('projectName'))]"
            },
            "projectName": {
              "type": "string",
              "metadata": {
                "description": "The name of the AI Foundry Project"
              },
              "value": "[parameters('projectName')]"
            },
            "hubPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "The principal ID of the AI Hub managed identity"
              },
              "value": "[reference(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('hubName')), '2024-04-01', 'full').identity.principalId]"
            },
            "projectPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "The principal ID of the AI Project managed identity"
              },
              "value": "[reference(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('projectName')), '2024-04-01', 'full').identity.principalId]"
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location of the AI Foundry resources"
              },
              "value": "[parameters('location')]"
            }
          }
        }
      },
      "dependsOn": [
        "containerRegistry",
        "monitoring"
      ]
    },
    "acrPullRoleAssignment": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('acr-role-{0}', variables('resourceToken'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[reference('containerRegistry').outputs.name.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "acrSku": {
            "value": "Basic"
          },
          "acrAdminUserEnabled": {
            "value": false
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "roleAssignments": {
            "value": [
              {
                "principalId": "[reference('appService').outputs.principalId.value]",
                "roleDefinitionIdOrName": "[variables('acrPullRoleId')]",
                "principalType": "ServicePrincipal"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11147634617806757127"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the Container Registry"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location of the Container Registry"
              }
            },
            "acrSku": {
              "type": "string",
              "defaultValue": "Basic",
              "allowedValues": [
                "Basic",
                "Standard",
                "Premium"
              ],
              "metadata": {
                "description": "The SKU name for the Container Registry"
              }
            },
            "acrAdminUserEnabled": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable admin user for Container Registry"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the Container Registry"
              }
            },
            "roleAssignments": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Role assignments for the Container Registry"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-07-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('acrSku')]"
              },
              "properties": {
                "adminUserEnabled": "[parameters('acrAdminUserEnabled')]",
                "publicNetworkAccess": "Enabled",
                "networkRuleBypassOptions": "AzureServices",
                "policies": {
                  "quarantinePolicy": {
                    "status": "disabled"
                  },
                  "retentionPolicy": {
                    "status": "disabled"
                  },
                  "trustPolicy": {
                    "status": "disabled"
                  }
                }
              }
            },
            {
              "copy": {
                "name": "containerRegistry_roleAssignments",
                "count": "[length(parameters('roleAssignments'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('name'))]",
              "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('name')), parameters('roleAssignments')[copyIndex()].principalId, parameters('roleAssignments')[copyIndex()].roleDefinitionIdOrName)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleAssignments')[copyIndex()].roleDefinitionIdOrName)]",
                "principalId": "[parameters('roleAssignments')[copyIndex()].principalId]",
                "principalType": "[coalesce(tryGet(parameters('roleAssignments')[copyIndex()], 'principalType'), 'ServicePrincipal')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerRegistry/registries', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Container Registry"
              },
              "value": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the Container Registry"
              },
              "value": "[parameters('name')]"
            },
            "loginServer": {
              "type": "string",
              "metadata": {
                "description": "The login server of the Container Registry"
              },
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('name')), '2023-07-01').loginServer]"
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location of the Container Registry"
              },
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('name')), '2023-07-01', 'full').location]"
            }
          }
        }
      },
      "dependsOn": [
        "appService",
        "containerRegistry"
      ]
    }
  },
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "The name of the resource group"
      },
      "value": "[resourceGroup().name]"
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "The location of the deployed resources"
      },
      "value": "[parameters('location')]"
    },
    "appServiceHostname": {
      "type": "string",
      "metadata": {
        "description": "The App Service default hostname"
      },
      "value": "[reference('appService').outputs.defaultHostname.value]"
    },
    "appServiceUrl": {
      "type": "string",
      "metadata": {
        "description": "The App Service URL"
      },
      "value": "[format('https://{0}', reference('appService').outputs.defaultHostname.value)]"
    },
    "acrLoginServer": {
      "type": "string",
      "metadata": {
        "description": "The Container Registry login server"
      },
      "value": "[reference('containerRegistry').outputs.loginServer.value]"
    },
    "appInsightsConnectionString": {
      "type": "securestring",
      "metadata": {
        "description": "The Application Insights connection string"
      },
      "value": "[reference('monitoring').outputs.appInsightsConnectionString.value]"
    },
    "aiHubName": {
      "type": "string",
      "metadata": {
        "description": "The AI Foundry Hub name"
      },
      "value": "[reference('aiFoundry').outputs.hubName.value]"
    },
    "aiProjectName": {
      "type": "string",
      "metadata": {
        "description": "The AI Foundry Project name"
      },
      "value": "[reference('aiFoundry').outputs.projectName.value]"
    },
    "resourceIds": {
      "type": "object",
      "metadata": {
        "description": "Resource IDs for reference"
      },
      "value": {
        "resourceGroup": "[resourceGroup().id]",
        "containerRegistry": "[reference('containerRegistry').outputs.resourceId.value]",
        "appServicePlan": "[reference('appServicePlan').outputs.resourceId.value]",
        "appService": "[reference('appService').outputs.resourceId.value]",
        "logAnalyticsWorkspace": "[reference('monitoring').outputs.workspaceResourceId.value]",
        "applicationInsights": "[reference('monitoring').outputs.appInsightsResourceId.value]",
        "aiHub": "[reference('aiFoundry').outputs.hubResourceId.value]",
        "aiProject": "[reference('aiFoundry').outputs.projectResourceId.value]"
      }
    }
  }
}